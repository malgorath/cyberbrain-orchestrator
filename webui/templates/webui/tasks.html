{% extends "base.html" %}
{% block title %}Tasks{% endblock %}
{% block content %}
  <div class="section">
    <h2>TaskDefinitions</h2>
    <div class="grid">
      <div class="panel">
        <h3 id="form-title">Create Task</h3>
        <input type="hidden" id="task-id" />
        {% include "partials/form_field.html" with field_id="key" label="Key (slug)" field_html="<input id='key' placeholder='log_triage' />" %}
        {% include "partials/form_field.html" with field_id="name" label="Name" field_html="<input id='name' placeholder='Log Triage' />" %}
        {% include "partials/form_field.html" with field_id="description" label="Description" field_html="<textarea id='description' placeholder='Describe task'></textarea>" %}
        {% include "partials/form_field.html" with field_id="enabled" label="Enabled" field_html="<select id='enabled'><option value='true' selected>True</option><option value='false'>False</option></select>" %}
        {% include "partials/form_field.html" with field_id="default_config" label="Default Config (JSON)" field_html="<textarea id='default_config' placeholder='{\"since_last_successful_run\": true}'></textarea>" help_text="No LLM prompt/response content should be stored." %}
        <div class="button-group">
          <button onclick="saveTask()">Save</button>
          <button class="btn-outline" onclick="resetForm()">Reset</button>
        </div>
      </div>
      <div class="panel">
        <div class="button-group">
          <button class="btn-secondary" onclick="refresh()">Refresh</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th><th>Key</th><th>Name</th><th>Enabled</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    async function refresh() {
      const res = await fetch('/api/tasks/');
      const data = await res.json();
      const items = Array.isArray(data) ? data : (data.results || []);
      const rows = items.map(x => `
        <tr>
          <td>${x.id}</td>
          <td>${x.key}</td>
          <td>${x.name}</td>
          <td>${x.enabled}</td>
          <td>
            <button class="btn-secondary btn-sm" onclick='loadTask(${JSON.stringify(x)})'>Edit</button>
            <button class="btn-outline btn-sm" onclick="toggle(${x.id}, ${x.enabled})">${x.enabled ? 'Disable' : 'Enable'}</button>
          </td>
        </tr>`).join('');
      document.getElementById('rows').innerHTML = rows || '<tr><td colspan="5">No tasks</td></tr>';
    }

    function loadTask(task) {
      document.getElementById('form-title').innerText = 'Edit Task';
      document.getElementById('task-id').value = task.id;
      document.getElementById('key').value = task.key;
      document.getElementById('name').value = task.name;
      document.getElementById('description').value = task.description || '';
      document.getElementById('enabled').value = String(task.enabled);
      document.getElementById('default_config').value = JSON.stringify(task.default_config || {}, null, 2);
    }

    function resetForm() {
      document.getElementById('form-title').innerText = 'Create Task';
      document.getElementById('task-id').value = '';
      document.getElementById('key').value = '';
      document.getElementById('name').value = '';
      document.getElementById('description').value = '';
      document.getElementById('enabled').value = 'true';
      document.getElementById('default_config').value = '';
    }

    async function saveTask() {
      const id = document.getElementById('task-id').value;
      const payload = {
        key: document.getElementById('key').value.trim(),
        name: document.getElementById('name').value.trim(),
        description: document.getElementById('description').value.trim(),
        enabled: document.getElementById('enabled').value === 'true',
        default_config: parseJson(document.getElementById('default_config').value || '{}'),
      };

      const url = id ? `/api/tasks/${id}/` : '/api/tasks/';
      const method = id ? 'PUT' : 'POST';
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        resetForm();
        refresh();
      } else {
        const err = await res.json();
        alert(JSON.stringify(err));
      }
    }

    async function toggle(id, enabled) {
      const res = await fetch(`/api/tasks/${id}/`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: !enabled }),
      });
      if (res.ok) refresh();
    }

    function parseJson(text) {
      try { return JSON.parse(text); } catch (e) { return {}; }
    }

    refresh();
  </script>
{% endblock %}
