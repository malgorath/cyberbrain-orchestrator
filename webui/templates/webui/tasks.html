<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tasks</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 10px; }
    .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
    label { display: block; margin-top: 8px; font-weight: 600; }
    input, textarea, select { width: 100%; padding: 6px; }
    textarea { height: 80px; }
    button { margin-top: 10px; margin-right: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f5f5f5; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h1>TaskDefinitions</h1>
  <div class="grid">
    <div>
      <h3 id="form-title">Create Task</h3>
      <input type="hidden" id="task-id" />
      <label>Key (slug)</label>
      <input id="key" placeholder="log_triage" />
      <label>Name</label>
      <input id="name" placeholder="Log Triage" />
      <label>Description</label>
      <textarea id="description" placeholder="Describe task"></textarea>
      <label>Enabled</label>
      <select id="enabled">
        <option value="true" selected>True</option>
        <option value="false">False</option>
      </select>
      <label>Default Config (JSON)</label>
      <textarea id="default_config" placeholder='{"since_last_successful_run": true}'></textarea>
      <div class="muted">No LLM prompt/response content should be stored.</div>
      <button onclick="saveTask()">Save</button>
      <button onclick="resetForm()">Reset</button>
    </div>
    <div>
      <div class="actions">
        <button onclick="refresh()">Refresh</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Key</th><th>Name</th><th>Enabled</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    async function refresh() {
      const res = await fetch('/api/tasks/');
      const data = await res.json();
      const items = Array.isArray(data) ? data : (data.results || []);
      const rows = items.map(x => `
        <tr>
          <td>${x.id}</td>
          <td>${x.key}</td>
          <td>${x.name}</td>
          <td>${x.enabled}</td>
          <td>
            <button onclick='loadTask(${JSON.stringify(x)})'>Edit</button>
            <button onclick="toggle(${x.id}, ${x.enabled})">${x.enabled ? 'Disable' : 'Enable'}</button>
          </td>
        </tr>`).join('');
      document.getElementById('rows').innerHTML = rows || '<tr><td colspan="5">No tasks</td></tr>';
    }

    function loadTask(task) {
      document.getElementById('form-title').innerText = 'Edit Task';
      document.getElementById('task-id').value = task.id;
      document.getElementById('key').value = task.key;
      document.getElementById('name').value = task.name;
      document.getElementById('description').value = task.description || '';
      document.getElementById('enabled').value = String(task.enabled);
      document.getElementById('default_config').value = JSON.stringify(task.default_config || {}, null, 2);
    }

    function resetForm() {
      document.getElementById('form-title').innerText = 'Create Task';
      document.getElementById('task-id').value = '';
      document.getElementById('key').value = '';
      document.getElementById('name').value = '';
      document.getElementById('description').value = '';
      document.getElementById('enabled').value = 'true';
      document.getElementById('default_config').value = '';
    }

    async function saveTask() {
      const id = document.getElementById('task-id').value;
      const payload = {
        key: document.getElementById('key').value.trim(),
        name: document.getElementById('name').value.trim(),
        description: document.getElementById('description').value.trim(),
        enabled: document.getElementById('enabled').value === 'true',
        default_config: parseJson(document.getElementById('default_config').value || '{}'),
      };

      const url = id ? `/api/tasks/${id}/` : '/api/tasks/';
      const method = id ? 'PUT' : 'POST';
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        resetForm();
        refresh();
      } else {
        const err = await res.json();
        alert(JSON.stringify(err));
      }
    }

    async function toggle(id, enabled) {
      const res = await fetch(`/api/tasks/${id}/`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: !enabled }),
      });
      if (res.ok) refresh();
    }

    function parseJson(text) {
      try { return JSON.parse(text); } catch (e) { return {}; }
    }

    refresh();
  </script>
</body>
</html>
