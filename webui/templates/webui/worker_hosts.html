{% extends "base.html" %}
{% block title %}Worker Hosts{% endblock %}
{% block content %}
  <div class="section">
    <h2>Worker Hosts</h2>
    <div class="grid">
      <div class="panel">
        <h3 id="form-title">Create Host</h3>
        <input type="hidden" id="host-id" />
        {% include "partials/form_field.html" with field_id="name" label="Name" field_html="<input id='name' placeholder='worker-1' />" %}
        {% include "partials/form_field.html" with field_id="type" label="Type" field_html="<select id='type'><option value='docker_socket'>docker_socket</option><option value='docker_tcp'>docker_tcp</option></select>" %}
        {% include "partials/form_field.html" with field_id="base_url" label="Base URL" field_html="<input id='base_url' placeholder='unix:///var/run/docker.sock' />" %}
        {% include "partials/form_field.html" with field_id="capabilities" label="Capabilities (JSON)" field_html="<textarea id='capabilities' placeholder='{}'></textarea>" %}
        {% include "partials/form_field.html" with field_id="enabled" label="Enabled" field_html="<select id='enabled'><option value='true' selected>True</option><option value='false'>False</option></select>" %}
        <div class="button-group">
          <button onclick="saveHost()">Save</button>
          <button class="btn-outline" onclick="resetForm()">Reset</button>
        </div>
      </div>
      <div class="panel">
        <div class="button-group">
          <button class="btn-secondary" onclick="refresh()">Refresh</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th><th>Name</th><th>Type</th><th>Enabled</th><th>Healthy</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="6">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    async function refresh() {
      const res = await fetch('/api/worker-hosts/');
      const data = await res.json();
      const items = Array.isArray(data) ? data : (data.results || []);
      const rows = items.map(x => `
        <tr>
          <td>${x.id}</td>
          <td>${x.name}</td>
          <td>${x.type}</td>
          <td>${x.enabled}</td>
          <td>${x.healthy}</td>
          <td>
            <button class="btn-secondary btn-sm" onclick='loadHost(${JSON.stringify(x)})'>Edit</button>
            <button class="btn-outline btn-sm" onclick="toggle(${x.id}, ${x.enabled})">${x.enabled ? 'Disable' : 'Enable'}</button>
          </td>
        </tr>`).join('');
      document.getElementById('rows').innerHTML = rows || '<tr><td colspan="6">No hosts</td></tr>';
    }

    function loadHost(host) {
      document.getElementById('form-title').innerText = 'Edit Host';
      document.getElementById('host-id').value = host.id;
      document.getElementById('name').value = host.name;
      document.getElementById('type').value = host.type;
      document.getElementById('base_url').value = host.base_url;
      document.getElementById('capabilities').value = JSON.stringify(host.capabilities || {}, null, 2);
      document.getElementById('enabled').value = String(host.enabled);
    }

    function resetForm() {
      document.getElementById('form-title').innerText = 'Create Host';
      document.getElementById('host-id').value = '';
      document.getElementById('name').value = '';
      document.getElementById('type').value = 'docker_socket';
      document.getElementById('base_url').value = '';
      document.getElementById('capabilities').value = '';
      document.getElementById('enabled').value = 'true';
    }

    async function saveHost() {
      const id = document.getElementById('host-id').value;
      const payload = {
        name: document.getElementById('name').value.trim(),
        type: document.getElementById('type').value,
        base_url: document.getElementById('base_url').value.trim(),
        capabilities: parseJson(document.getElementById('capabilities').value || '{}'),
        enabled: document.getElementById('enabled').value === 'true',
      };

      const url = id ? `/api/worker-hosts/${id}/` : '/api/worker-hosts/';
      const method = id ? 'PATCH' : 'POST';
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        resetForm();
        refresh();
      } else {
        const err = await res.json();
        alert(JSON.stringify(err));
      }
    }

    async function toggle(id, enabled) {
      const res = await fetch(`/api/worker-hosts/${id}/`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: !enabled }),
      });
      if (res.ok) refresh();
    }

    function parseJson(text) {
      try { return JSON.parse(text); } catch (e) { return {}; }
    }

    refresh();
  </script>
{% endblock %}
