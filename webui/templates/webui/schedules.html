{% extends "base.html" %}
{% block title %}Schedules{% endblock %}
{% block content %}
  <div class="section">
    <h2>Schedules</h2>
    <div class="grid">
      <div class="panel">
        <h3 id="form-title">Create Schedule</h3>
        <input type="hidden" id="schedule-id" />
        {% include "partials/form_field.html" with field_id="name" label="Name" field_html="<input id='name' placeholder='triage-every-5' />" %}
        {% include "partials/form_field.html" with field_id="task_id" label="Task" field_html="<select id='task_id'></select>" %}
        {% include "partials/form_field.html" with field_id="schedule_type" label="Type" field_html="<select id='schedule_type' onchange='toggleScheduleFields()'><option value='one_shot'>one_shot</option><option value='interval' selected>interval</option><option value='cron'>cron</option></select>" %}
        {% include "partials/form_field.html" with field_id="interval_minutes" label="Interval Minutes" field_html="<input id='interval_minutes' type='number' min='1' />" %}
        {% include "partials/form_field.html" with field_id="cron_expr" label="Cron Expr" field_html="<input id='cron_expr' placeholder='0 */2 * * *' />" %}
        {% include "partials/form_field.html" with field_id="timezone" label="Timezone" field_html="<input id='timezone' value='UTC' />" %}
        {% include "partials/form_field.html" with field_id="enabled" label="Enabled" field_html="<select id='enabled'><option value='true' selected>True</option><option value='false'>False</option></select>" %}
        {% include "partials/form_field.html" with field_id="next_run_at" label="Next Run At (one_shot only, ISO)" field_html="<input id='next_run_at' placeholder='2025-01-10T12:00:00Z' />" %}
        <div class="button-group">
          <button onclick="saveSchedule()">Save</button>
          <button class="btn-outline" onclick="resetForm()">Reset</button>
        </div>
      </div>
      <div class="panel">
        <div class="button-group">
          <button class="btn-secondary" onclick="refresh()">Refresh</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ID</th><th>Name</th><th>Task</th><th>Type</th><th>Next Run</th><th>Enabled</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="7">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    async function refresh() {
      await loadTasks();
      const res = await fetch('/api/schedules/');
      const data = await res.json();
      const items = Array.isArray(data) ? data : (data.results || []);
      const rows = items.map(x => `
        <tr>
          <td>${x.id}</td>
          <td>${x.name}</td>
          <td>${x.task_key_read || ''}</td>
          <td>${x.schedule_type}</td>
          <td>${x.next_run_at || ''}</td>
          <td>${x.enabled}</td>
          <td>
            <button class="btn-secondary btn-sm" onclick="runNow(${x.id})">Run Now</button>
            <button class="btn-outline btn-sm" onclick="toggle(${x.id}, ${x.enabled})">${x.enabled ? 'Disable' : 'Enable'}</button>
            <button class="btn btn-sm" onclick='loadSchedule(${JSON.stringify(x)})'>Edit</button>
          </td>
        </tr>`).join('');
      document.getElementById('rows').innerHTML = rows || '<tr><td colspan="7">No schedules</td></tr>';
    }

    async function runNow(id) {
      const res = await fetch(`/api/schedules/${id}/run-now/`, { method: 'POST' });
      if (res.ok) {
        alert('Triggered run-now');
        refresh();
      } else {
        alert('Run-now failed');
      }
    }

    async function toggle(id, enabled) {
      const path = enabled ? 'disable' : 'enable';
      const res = await fetch(`/api/schedules/${id}/${path}/`, { method: 'POST' });
      if (res.ok) refresh();
    }

    async function loadTasks() {
      const res = await fetch('/api/tasks/');
      const data = await res.json();
      const items = Array.isArray(data) ? data : (data.results || []);
      const select = document.getElementById('task_id');
      select.innerHTML = items.map(t => `<option value="${t.id}">${t.key}</option>`).join('');
    }

    function loadSchedule(schedule) {
      document.getElementById('form-title').innerText = 'Edit Schedule';
      document.getElementById('schedule-id').value = schedule.id;
      document.getElementById('name').value = schedule.name;
      document.getElementById('task_id').value = schedule.task_id_read || '';
      document.getElementById('schedule_type').value = schedule.schedule_type;
      document.getElementById('interval_minutes').value = schedule.interval_minutes || '';
      document.getElementById('cron_expr').value = schedule.cron_expr || '';
      document.getElementById('timezone').value = schedule.timezone || 'UTC';
      document.getElementById('enabled').value = String(schedule.enabled);
      document.getElementById('next_run_at').value = schedule.next_run_at || '';
      toggleScheduleFields();
    }

    function resetForm() {
      document.getElementById('form-title').innerText = 'Create Schedule';
      document.getElementById('schedule-id').value = '';
      document.getElementById('name').value = '';
      document.getElementById('interval_minutes').value = '';
      document.getElementById('cron_expr').value = '';
      document.getElementById('timezone').value = 'UTC';
      document.getElementById('enabled').value = 'true';
      document.getElementById('next_run_at').value = '';
      toggleScheduleFields();
    }

    function toggleScheduleFields() {
      const type = document.getElementById('schedule_type').value;
      document.getElementById('interval_minutes').disabled = type !== 'interval';
      document.getElementById('cron_expr').disabled = type !== 'cron';
      document.getElementById('next_run_at').disabled = type !== 'one_shot';
    }

    async function saveSchedule() {
      const id = document.getElementById('schedule-id').value;
      const payload = {
        name: document.getElementById('name').value.trim(),
        task_id: Number(document.getElementById('task_id').value),
        schedule_type: document.getElementById('schedule_type').value,
        interval_minutes: document.getElementById('interval_minutes').value ? Number(document.getElementById('interval_minutes').value) : null,
        cron_expr: document.getElementById('cron_expr').value.trim(),
        timezone: document.getElementById('timezone').value.trim(),
        enabled: document.getElementById('enabled').value === 'true',
        next_run_at: document.getElementById('next_run_at').value.trim() || null,
      };
      const url = id ? `/api/schedules/${id}/` : '/api/schedules/';
      const method = id ? 'PUT' : 'POST';
      const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (res.ok) {
        resetForm();
        refresh();
      } else {
        const err = await res.json();
        alert(JSON.stringify(err));
      }
    }

    refresh();
  </script>
{% endblock %}
